{% extends 'base.html' %} 
{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
<style>
    #location-picker-map {
        height: 300px;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>

<div class="container py-5">
    <div class="row">
        <div class="col-lg-9 mx-auto">
            <h2 class="fw-bold mb-4">Edit Profile</h2>

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Render hidden fields first -->
                {{ profile_form.latitude }}
                {{ profile_form.longitude }}

                <!-- Profile Information Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center">
                        <div><i class="fas fa-user-circle me-2"></i>Profile Information</div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="d-flex align-items-center gap-2">
                                <label for="{{ profile_form.resume_visibility.id_for_label }}" class="mb-0 small fw-normal">Resume Visibility:</label>
                                {{ profile_form.resume_visibility }}
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        {{ profile_form.name.as_field_group }}
                        {{ profile_form.bio.as_field_group }}

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                {{ profile_form.location.label_tag }}
                                <button type="button" id="center-on-me-btn" class="btn btn-sm btn-outline-secondary" title="Center map on your location">
                                    <i class="fas fa-crosshairs me-1"></i>Center on me
                                </button>
                            </div>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                {{ profile_form.location }}
                            </div>
                            <div id="location-picker-map"></div>
                            <small class="form-text text-muted">
                                Enter a general location name above, then click the map to set the exact position.
                            </small>
                        </div>
                        
                        <div class="mb-2">
                            <label for="{{ profile_form.resume.id_for_label }}" class="form-label fw-medium">{{ profile_form.resume.label }}</label>
                            <div class="input-group">
                                {{ profile_form.resume }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Skills Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center">
                        <div><i class="fas fa-cogs me-2"></i>Skills</div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="d-flex align-items-center gap-2">
                                <label for="{{ profile_form.skills_visibility.id_for_label }}" class="mb-0 small fw-normal">Visibility:</label>
                                {{ profile_form.skills_visibility }}
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-light" 
                                    hx-get="{% url 'manage_form_rows' formset_name='skills' %}" 
                                    hx-target="#skills-forms" 
                                    hx-swap="beforeend">
                                <i class="fas fa-plus-circle me-1"></i>Add
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {{ skill_formset.management_form }}
                        <div id="skills-forms">
                            {% for form in skill_formset %}
                                {% include 'partials/form_row.html' with form=form prefix='skills' %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Education Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center">
                        <div><i class="fas fa-graduation-cap me-2"></i>Education</div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="d-flex align-items-center gap-2">
                                <label for="{{ profile_form.education_visibility.id_for_label }}" class="mb-0 small fw-normal">Visibility:</label>
                                {{ profile_form.education_visibility }}
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-light"
                                    hx-get="{% url 'manage_form_rows' formset_name='education' %}"
                                    hx-target="#education-forms"
                                    hx-swap="beforeend">
                                <i class="fas fa-plus-circle me-1"></i>Add
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {{ education_formset.management_form }}
                        <div id="education-forms">
                            {% for form in education_formset %}
                                {% include 'partials/form_row.html' with form=form prefix='education' %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Experience Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center">
                        <div><i class="fas fa-briefcase me-2"></i>Experience</div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="d-flex align-items-center gap-2">
                                <label for="{{ profile_form.experience_visibility.id_for_label }}" class="mb-0 small fw-normal">Visibility:</label>
                                {{ profile_form.experience_visibility }}
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-light"
                                    hx-get="{% url 'manage_form_rows' formset_name='experience' %}"
                                    hx-target="#experience-forms"
                                    hx-swap="beforeend">
                                <i class="fas fa-plus-circle me-1"></i>Add
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {{ experience_formset.management_form }}
                        <div id="experience-forms">
                            {% for form in experience_formset %}
                                {% include 'partials/form_row.html' with form=form prefix='experience' %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Links Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center">
                        <div><i class="fas fa-link me-2"></i>Links</div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="d-flex align-items-center gap-2">
                                <label for="{{ profile_form.links_visibility.id_for_label }}" class="mb-0 small fw-normal">Visibility:</label>
                                {{ profile_form.links_visibility }}
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-light"
                                    hx-get="{% url 'manage_form_rows' formset_name='links' %}"
                                    hx-target="#links-forms"
                                    hx-swap="beforeend">
                                <i class="fas fa-plus-circle me-1"></i>Add
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {{ link_formset.management_form }}
                        <div id="links-forms">
                            {% for form in link_formset %}
                                {% include 'partials/form_row.html' with form=form prefix='links' %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary btn-lg fw-bold">
                        Save Profile
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Add the CSRF token to all HTMX requests
document.body.addEventListener('htmx:configRequest', function(evt) {
    evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
});

// Listen for custom events triggered by the server after a formset item is deleted.
['skills', 'education', 'experience', 'links'].forEach(prefix => {
    document.body.addEventListener(`formset-item-deleted-${prefix}`, function(evt) {
        // Find the management form's TOTAL_FORMS input for the specific formset.
        const totalFormsInput = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);
        if (totalFormsInput) {
            // Decrement the count to keep the form state in sync with the UI.
            const currentCount = parseInt(totalFormsInput.value, 10);
            if (currentCount > 0) totalFormsInput.value = currentCount - 1;
        }
    });
});

document.body.addEventListener('htmx:afterSwap', function(evt) {
    // This event fires after a new form row has been added.
    // We only care about successful GET requests that add a new form row.
    const request = evt.detail.xhr;
    if (request.status === 200 && request.response) {
        // Find the target container where the new form was added.
        const target = evt.detail.target;
        if (target) {
            // Get the prefix from the target's ID (e.g., 'skills-forms' -> 'skills').
            const prefix = target.id.replace('-forms', '');
            // Find the management form's TOTAL_FORMS input for this specific formset.
            const totalFormsInput = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);

            if (totalFormsInput) {
                // Get the current form count, which will be the index for our new form.
                const formIndex = parseInt(totalFormsInput.value, 10);

                // Find the newly added form row, which is always the last one and still has the '__prefix__' placeholder.
                const newFormRow = Array.from(target.children).find(child => child.innerHTML.includes('__prefix__'));

                if (newFormRow) {
                    // Use a regular expression to globally replace all instances of '__prefix__'.
                    // This is crucial for updating all attributes ('name', 'id', 'for') correctly.
                    newFormRow.innerHTML = newFormRow.innerHTML.replace(/__prefix__/g, formIndex);
                }

                // Finally, increment the TOTAL_FORMS count so the management form is correct for the next submission.
                totalFormsInput.value = parseInt(totalFormsInput.value, 10) + 1;
            }
        }
    }
});
</script>
{% endblock content %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const latField = document.getElementById('id_latitude');
    const lonField = document.getElementById('id_longitude');
    const locationField = document.getElementById('id_location');
    const centerBtn = document.getElementById('center-on-me-btn');

    let marker; // Marker instance
    let map;    // Map instance

    function setupMap(center, zoom) {
        map = L.map('location-picker-map').setView(center, zoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // If editing, place the initial marker
        if (latField.value && lonField.value) {
            marker = L.marker([parseFloat(latField.value), parseFloat(lonField.value)]).addTo(map);
        }

        // When the map is clicked, update the location
        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            updateLocation(lat, lng);
        });
    }

    // NEW: Function to update location fields, marker, and reverse geocode
    function updateLocation(lat, lng) {
        latField.value = lat.toFixed(6);
        lonField.value = lng.toFixed(6);
        
        const latLng = [lat, lng];

        if (marker) {
            marker.setLatLng(latLng);
        } else {
            marker = L.marker(latLng).addTo(map);
        }
        
        // Reverse Geocoding to get a human-readable location name
        const reverseGeocodeUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
        fetch(reverseGeocodeUrl)
            .then(response => response.json())
            .then(data => {
                if (data && data.address) {
                    const address = data.address;
                    const locationParts = [
                        address.city || address.town || address.village,
                        address.state,
                        address.country
                    ].filter(Boolean);
                    locationField.value = locationParts.join(', ');
                }
            })
            .catch(error => console.error('Error with reverse geocoding:', error));
    }
    
    // Determine initial center and zoom
    let initialCenter = [39.8283, -98.5795]; // Default USA
    let initialZoom = 4;

    // If editing a profile with existing location, use its coordinates
    if (latField.value && lonField.value) {
        initialCenter = [parseFloat(latField.value), parseFloat(lonField.value)];
        initialZoom = 12;
    }
    
    setupMap(initialCenter, initialZoom);

    // If no location is set, try to get user's current location to center the map
    if (!latField.value && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLocation = [position.coords.latitude, position.coords.longitude];
                map.setView(userLocation, 12);
            },
            () => { console.log("Geolocation failed or denied for edit_profile map."); }
        );
    } 

    // NEW: Event listener for the "Center on me" button
    centerBtn.addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    map.setView([latitude, longitude], 13); // Center the map
                    updateLocation(latitude, longitude); // Update marker and fields
                },
                () => {
                    alert("Could not get your location. Please ensure you have granted location permissions to your browser.");
                }
            );
        } else {
            alert("Geolocation is not supported by your browser.");
        }
    });
});
</script>
{% endblock extra_js %}
